# ネットワーク
## 本書の目的
ネットワーク構成の基本的な考え方、設計方針を示す。

## 関連資料
本書の前提となる資料、情報元となる資料は以下の通り。  

* [非機能要件一覧](https://docs.google.com/spreadsheets/d/1B5z5-YWOrzDnu0gY5AM-_wRCRX9LD9EZ/edit?usp=share_link&ouid=106375452255861814726&rtpof=true&sd=true)
* [構築ガイドライン](https://drive.google.com/file/d/1KaAbHae4c2WQy37im2Ujmpvk_nD-QD8-/view?usp=share_link)
* [クラウドセキュリティガイドライン](https://docs.google.com/document/d/1uHi7mWWJaxotaLL3iJ90vqa7ZCzF9PId/edit?usp=share_link&ouid=106375452255861814726&rtpof=true&sd=true)
* [POHR論理システム構成図](https://app.diagrams.net/#G122z8inmGkVqX_vwh6zkzKVSDbcr20eBX)

# 対象非機能要件
本書に関連する対象非機能要件は以下の通り。

|大項目|項番|定義項目|決定メトリクス|備考|
|---|---|---|---|---|
|可用性|A.1.2.2|業務継続性|サービス切替時間＝60分未満||
|可用性|A.1.2.3|業務継続性|・業務継続の要求度<br>単一障害時は業務停止を許容せず、処理を継続させる|・単一の定義<br>単一の定義をZONE・基盤の種類とする|
|可用性|A.1.5.1|稼働率|95%| |
|可用性|A.2.1.1|耐障害性 サーバ|全てのサーバで冗長化| |
|可用性|A.2.4.3|セグメント分割|用途に応じて分割|各ZONE毎にAWSアカウントを分ける|
|可用性|A.4.1.1|復旧作業|復旧用製品による復旧|各種サーバにおいて、冗長構成にし、AWS機能にて自動フェイルオーバーを実現|
|セキュリティ|E.1.1.1|情報セキュリティに関するコンプライアンス|順守すべき社内規程、ルール、法令、ガイドライン等有|LION様策定のクラウドセキュリティガイドライン、構築ガイドラインを従った設計|
|セキュリティ|E.6.1.1|伝送データの暗号化の有無|重要情報を暗号化|インターネット経由またはVPC内の通信はSSL/TLSプロトコルを用いる|
|セキュリティ|E.7.1.4|不正監視対象（ネットワーク）|重要度が高い資産を扱う範囲、あるいは、外接部分|ネットワークへの不正アクセスについてVPC FlowLogにて検知する|
|セキュリティ|E.8.1.1|ネットワーク対策 通信制御|有り|外部からの通信においてはCloudfrareでの遮断制御を行う<br>各ZONEのシステム間通信においてはTransit Gatewayにて行う|
|セキュリティ|E.8.3.1|ネットワークの輻輳対策|有り|AWS Shieldサービスの利用|
|システム環境・エコロジー|F.1.1.1/F.1.2.1|構築/運用時の制約条件|制約有り(重要な制約のみ適用)|LION様提供のAWSクラウドセキュリティガイドライン、AWS構築ガイドライン|

## ネットワーク構築方針
### P-ZONE/D-ZONE/L-ZONE
1. マネージドサービスで構成するpublic層(インターネットからのリクエスト受付をし、DMZに該当する層）
1. 内部の処理用のVPC(メインの処理のlambda,ECS,DBが配置するprivate VPC層)
1.  外部との通信用のVPC(NATゲートウェイ、インターネットゲートウェイを配置して外部と通信するpublicVPC層)
<br>1がAWSが提供するVPC外のpublic層、2と3が本プロジェクトで構築するVPC内 VPC内に配置するサブネットは、3ゾーンのマルチAZ構成としてそれぞれにlambda等のサービスコンポーネントを配置して冗長化の構成とする
### オーラル基盤/通知配信基盤
1. 内部の処理用のVPC(メインの処理のlambda,ECS,DBが配置するprivate VPC層)
1.  外部との通信用のVPC(NATゲートウェイ、インターネットゲートウェイを配置して外部と通信するpublicVPC層)


ネットワーク構成図サンプルは下記を参照<br>
[ネットワーク構成図サンプル](https://drive.google.com/file/d/1Ae_o23Kc1RZHvfCiYQL90eXB1InYGuJE/view?usp=share_link)

## CIDR
VPC に割り当てるCIDRは以下の通り。  

| 実行環境 | CIDR       |
| -------- | ---------- |
| 本番     | 10.x.0.0/16 32768|
| ステージング | 10.x+1.0.0/16 32768|
| 開発 | 10.x+2.0.0/16 32768|
| 性能試験 | 10.x+3.0.0/16 32768|

## Cloudfrare
遮断制御や内外のDNSサーバーはCloudfrareを使用する。

## AWS Shield
ネットワーク輻輳対策としてAWS Shieldを使用する。

## VPC Flow Logs
VPC 内トラフィックをログとして保管する。  
VPCFlowLogsはネットワークへの不正アクセス監視に使用する。  

VPC Flow Logs 設定。

| 項目     | 設定値                       |
| -------- | --------------------------------------------------- |
| 対象     | VPC or サブネット or ネットワーク・インターフェース |
| 保管先   | S3 / CloudWatchLogs                        |

## サブネット設計
VPC 内は目的に応じて複数のサブネットを作成する。  
サブネットはルートテーブル(経路情報)を基準に作成する。  

### 実行環境サブネット
外部との通信はすべて暗号化を行う。
| サブネット名      | ルートテーブル            | 通信暗号化 |CIDR|
| ---------- | ------------------------------- | ---- |---------|
| パブリックサブネット  | Internet Gateway への経路を持つ | 有り（TLS1.2)   |10.x.0.0/19 8192|
| プライベートサブネット  | VPC 内部通信に限定  | 無し  |10.x.32.0/17 32768|
| システム間連携サブネット | Transit Gatewayへの経路を持つ  |  無し    |10.x.108.0/28 16|


## セキュリティグループ
- VPC内はセキュリティグループにて必要な通信のみ許可する
- セキュリティグループは原則として1リソース1セキュリティグループとする(冗長化されているものは共有で1つとする)
- セキュリティグループの構成は詳細設計のパラメータシートに記載する。

## ネットワークACL
ネットワークACLは、原則利用しない(通信の制限はルートテーブルとセキュリティーグループで行う)。


## Internet GateWay
インターネットアクセスが必要なリソースが存在するため、Internet Gateway を使用する。  

## NAT Gateway
アウトバウンドのみのインターネットアクセスが必要なリソースが存在するため、NAT Gateway を使用する。  
NAT Gateway は可用性確保のため Availability Zone ごとに作成する。   

## VPC エンドポイント
プライベートサブネット上のリソースから AWS サービスへのアクセスについて、必要に応じてVPC エンドポイントを作成する。  

VPC エンドポイントがサポートされている AWS サービスは AWS ドキュメントに記載がある。  
[VPC エンドポイント](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/vpc-endpoints.html)  


## 踏み台サーバー
開発/運用拠点からのリモートログイン用に踏み台サーバーを設置する。  
踏み台サーバーは Single-AZ 構成とし、使用していない時間帯はシャットダウンしておく。  

## Transit gateway
VPC 間通信にはTransit Gatewayを使用する。    

 

