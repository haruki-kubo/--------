
# はじめに

## 本書の目的

本書は非機能要件、LION様提供の構築ガイドライン、クラウドセキュリティガイドラインに基づき、クラウドの特徴を活かした可用性の高いシステム構築を行えることを第一に考える。 

## 関連資料
本書の前提となる資料、情報元となる資料は以下の通り。  

* [非機能要件一覧](https://docs.google.com/spreadsheets/d/1B5z5-YWOrzDnu0gY5AM-_wRCRX9LD9EZ/edit?usp=share_link&ouid=106375452255861814726&rtpof=true&sd=true)
* [構築ガイドライン](https://drive.google.com/file/d/1KaAbHae4c2WQy37im2Ujmpvk_nD-QD8-/view?usp=share_link)
* [クラウドセキュリティガイドライン](https://docs.google.com/document/d/1uHi7mWWJaxotaLL3iJ90vqa7ZCzF9PId/edit?usp=share_link&ouid=106375452255861814726&rtpof=true&sd=true)
* [POHR論理システム構成図](https://app.diagrams.net/#G122z8inmGkVqX_vwh6zkzKVSDbcr20eBX)

# 対象非機能要件
本書に関連する対象非機能要件は以下の通り。

|大項目|項番|定義項目|決定メトリクス|備考|
|---|---|---|---|---|
|可用性|A.1.1.1<br>A.1.1.2|運用スケジュール|24時間無停止| |
|可用性|A.1.1.3|運用スケジュール|計画停止無し|定期的なシステム停止イベントは含まない<br>システム上の例：Postgresのバージョンアップ etc|
|可用性|A.1.5.1|稼働率|95%|1年間87時間(３ヶ月１度程度)|
|可用性|A.2.1.1|耐障害性<br>サーバ|全てのサーバで冗長化| |
|可用性|A.4.1.1|復旧作業|復旧用製品による復旧|各種サーバにおいて、冗長構成にし、AWS機能にて自動フェイルオーバーを実現|
|運用・保守性|C.1.1.1<br>C.1.1.2|運用時間|運用時間＝24時間無停止<br>（通常、特定日）| |
|運用・保守性|C.2.1.1|計画停止|計画停止無し|AWSの緊急メンテナンスを除く|
|運用・保守性|C.2.1.2|計画停止の事前アナウンス|計画停止が存在しない|AWSの緊急メンテナンスによる停止については1週間前に通知する|

## システム稼働率
定めた非機能要件にて決定したシステム稼働率は下記の通り 

|稼働率|停止時間目安（年間）|備考|
|---|---|---|
|95%|18.3日|Ver2では99%(年間87.6時間停止）|
ただし、AWS は、サービス レベル アグリーメント (SLA) を提供しているため、SLOとしての定義で想定
https://aws.amazon.com/legal/service-level-agreements/?aws-sla-cards.sort-by=item.additionalFields.serviceNameLower&aws-sla-cards.sort-order=asc&awsf.tech-category-filter=*all

## 基本稼働時間
本番環境は 24時間稼働とする。
ステージング環境はコストを考慮して平日10時～18時(日本時間)の稼働とする。
また、開発環境/性能試験については原則停止する。（使用時のみ起動する運用）  

## メンテナンススケジュール
システムの安定稼働を目的をしたメンテナンスを実施する。  
メンテナンスと頻度は以下の通り。  

|管理エリア|メンテナンス内容|停止有無|頻度|実行トリガー|
|---|---|---|---|---|
|OS|OS パッチ適用|有り|個別計画のうえ|手動 (パッチ適用作業は自動化する)|
|ミドルウェア|MW パッチ適用|有り|個別計画のうえ|手動|
|RDS|自動メンテナンスを行う|有り|個別計画のうえ|手動|

## 計画停止
メンテナンススケジュールに規定されない特別なメンテナンスを行うためにシステムの計画停止を行う。  
計画停止は、１週間前にユーザーへ停止日時を通知し、その時間帯にシステムを停止する。  

想定される計画停止は以下の通り。  

* AWSの大規模メンテナンスによるシステム停止
* 社会的に影響の大きいセキュリティパッチの適用
* 社内設備の点検によるシステム停止

## データセンターレベルの可用性
AWS は物理的に分離された複数のデータセンターで Availability Zone が構成されている。  
1つのリージョンは複数の Availability Zone で構成されている。  

対象システムはMulti-AZで冗長構成を組む。  
Multi-AZの効果を最大限に活かすためマネージドサービスを積極的に採用する。    

## リージョン間の冗長構成
リージョンを跨いだ冗長構成は採用しない。  
（Ver2ではコストやリスクを鑑みて、リージョン間の冗長構成を行うことも検討）

## 冗長構成パターン
### マネージドサービス
AWS が提供しているマネージドサービスを使って冗長構成をする。  
マネージドサービスは Multi-AZ 前提で設計されているので積極的に活用する。  
  
### Cloudfrontによる冗長
WEBサーバーの上段にCloudfrontを配置する。
負荷分散の効果も見込む。 

### ELB/API Gateway による冗長
APサーバーの上段にELB/API Gatewayを配置する。
負荷分散の効果も見込む。  

### RDS Proxyによる冗長
DBサーバーとしてRDSを採用する場合にはAPサーバーとDBサーバー間にRDS Proxyを配置する。
接続プールを管理し、アプリケーションからのアクセスと頻度の効率化を見込む。  

## 通知配信サービス リクエスト制約による可用性
利用するサービスのSMS/Email/FCMの配信リクエスト制約に基づき
SQSサービスを用いて利用するサービスのリクエスト超過処理を防止する。